"use strict";angular.module("angular-talk",[]).controller("AngularTalkController",["$scope","$http","$timeout","windowStatus",function(n,e,t,i){n.messages=[],n.getMessageID=function(e){return n.settings.channel+"_"+e.id},n.submit=function(){if(""!=n.content.length){var e;n.editingMessage?(e=n.editingMessage,e.content=n.content,n.editingMessage=null):(e={author:n.settings.sender,content:n.content,date:new Date/1e3|0},n.replyingTo&&(e.replyToID=n.replyingTo.id),n.messages.push(e)),n.sendMessage(e),n.content="",n.replyingTo=null}},n.sendMessage=function(t){t.isSending=!0,t.isError=!1,e.post(n.settings.ajaxEndpoint,t,{params:{method:t.id?"update":"submit"}}).success(function(n){t.isSending=!1,n.data&&(t.isError=!1,angular.extend(t,n.data))}).error(function(){t.isSending=!1,t.isError=!0})},n.messageKeyPress=function(e){return n.settings.submitOnEnter&&13==e.keyCode?(n.submit(),e.preventDefault(),!1):void 0},n.replyingTo=null,n.reply=function(e){n.replyingTo=e},n.editingMessage=null,n.edit=function(e){n.editingMessage=e,n.content=e.content},n.delete=function(t){confirm(n.settings.strings.delete_confirm)&&e.post(n.settings.ajaxEndpoint,t,{params:{method:"delete"}}).success(function(){var e=n.messages.indexOf(t);e>=0&&n.messages.splice(e,1)})};var o,s=!1,d=0;n.$watch("settings",function(a){if(!s){s=!0;var r=null;n.settings.soundOnNew&&(angular.isString(n.settings.soundOnNew)?r=new Audio(n.settings.soundOnNew):(r=document.createElement("audio"),angular.forEach(n.settings.soundOnNew,function(n,e){var t=document.createElement("source");t.type=e,t.src=n,r.appendChild(t)})));var u=function(t,s){n.loading=!0,e.get(n.settings.ajaxEndpoint,{params:angular.extend({method:"messages",since:d,dir:"ASC",count:25},t)}).success(function(e){if(e.data){var t=0;angular.forEach(e.data,function(e){var i=!1;angular.forEach(n.messages,function(n){n.id&&n.id==e.id&&(i=!0)}),i||(e.id>d&&(d=e.id),(e.id<o||angular.isUndefined(o))&&(o=e.id),n.messages.push(e),t++)}),t>0&&r&&i.hidden&&r.play(),s&&s(e)}n.loading=!1}).error(function(){n.loading=!1,s&&s(!1)})};n.loadingOlder=!1,n.disableOlder=!1,n.onScroll=function(e){n.disableOlder||0!=e||(console.log("Load old messages"),n.loadingOlder=!0,u({since:o,dir:"DESC"},function(e){0==e.data.length&&(n.disableOlder=!0),n.loadingOlder=!1}))};var c=function(){a.updateInterval&&t(function(){u({},c)},a.updateInterval)};u({},c),n.$on("$destroy",function(){a.updateInterval=!1})}})}]).directive("angularTalkScroll",function(){return{priority:1,scope:{onScroll:"&"},restrict:"A",link:function(n,e){function t(){o.scrollTop=o.scrollHeight}function i(){return o.scrollTop+o.clientHeight+1>=o.scrollHeight}var o=e[0],s=!0;n.show=function(e){var t=document.getElementById(n.getMessageID(e));t&&(o.scrollTop=t.offsetTop)},n.$watch(function(){s&&t()}),e.bind("scroll",function(){s=i(),n.onScroll({offset:o.scrollTop})})}}}).service("windowStatus",function(){function n(n){var i={focus:!0,focusin:!0,pageshow:!0,blur:!1,focusout:!1,pagehide:!1};n=n||window.event,e.visible=n.type in i?i[n.type]:this[t]?!1:!0,e.hidden=!e.visible}var e={visible:!0,hidden:!1},t="hidden";return t in document?document.addEventListener("visibilitychange",n):(t="mozHidden")in document?document.addEventListener("mozvisibilitychange",n):(t="webkitHidden")in document?document.addEventListener("webkitvisibilitychange",n):(t="msHidden")in document?document.addEventListener("msvisibilitychange",n):"onfocusin"in document?document.onfocusin=document.onfocusout=n:window.onpageshow=window.onpagehide=window.onfocus=window.onblur=n,void 0!==document[t]&&n({type:document[t]?"blur":"focus"}),e}).run(["windowStatus",function(){}]);