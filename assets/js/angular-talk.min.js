"use strict";angular.module("angular-talk",[]).directive("angularTalk",["$http","$timeout","windowStatus",function(n,e,t){return{restrict:"AC",scope:{},templateUrl:"angularTalk/room.html",link:function(i,o,s){var a=i.settings={};if(angular.forEach(s,function(n,e){i.settings[e]=""==n?!0:["strings","sender","soundOnNew"].indexOf(e)>=0?i.$eval(n):n}),!a.ajaxEndpoint)throw new Error("Invalid ajax endpoint");i.messages=[],i.getMessageID=function(n){return a.channel+"_"+n.id},i.submit=function(){if(""!=i.content.length){var n;i.editingMessage?(n=i.editingMessage,n.content=i.content,i.editingMessage=null):(n={author:a.sender,content:i.content,date:new Date/1e3|0},i.replyingTo&&(n.replyToID=i.replyingTo.id),i.messages.push(n)),i.sendMessage(n),i.content="",i.replyingTo=null}},i.sendMessage=function(e){e.isSending=!0,e.isError=!1,n.post(a.ajaxEndpoint,e,{params:{method:e.id?"update":"submit"}}).success(function(n){e.isSending=!1,n.data&&(e.isError=!1,angular.extend(e,n.data),i.$emit("messageSend",e))}).error(function(){e.isSending=!1,e.isError=!0})},i.messageKeyPress=function(n){return a.submitOnEnter&&13==n.keyCode?(i.submit(),n.preventDefault(),!1):void 0},i.replyingTo=null,i.reply=function(n){i.replyingTo=n},i.getReplies=function(n){var e=[];return angular.forEach(i.messages,function(t){t.replyToID==n&&e.push(t)}),e},i.editingMessage=null,i.edit=function(n){i.editingMessage=n,i.content=n.content},i.delete=function(e){confirm(a.strings.delete_confirm)&&n.post(a.ajaxEndpoint,e,{params:{method:"delete"}}).success(function(){var n=i.messages.indexOf(e);n>=0&&i.messages.splice(n,1)})},i.previousMessage=function(n){var e=void 0;return angular.forEach(i.messages,function(t){t.replyToID==n.replyToID&&t.id!=n.id&&t.date<=n.date&&(!e||e.date<t.date)&&(e=t)}),e};var d,r=0,u=null;a.soundOnNew&&(angular.isString(a.soundOnNew)?u=new Audio(a.soundOnNew):(u=document.createElement("audio"),angular.forEach(a.soundOnNew,function(n,e){var t=document.createElement("source");t.type=e,t.src=n,u.appendChild(t)})));var c=function(e,o,s){i.loading=!0,n.get(a.ajaxEndpoint,{params:angular.extend({method:"messages",since:r,dir:"ASC",count:25},e)}).success(function(n){if(n.data){var e=0;angular.forEach(n.data,function(n){var t=!1;angular.forEach(i.messages,function(e){e.id&&e.id==n.id&&(t=!0)}),t||(n.id>r&&(r=n.id),(n.id<d||angular.isUndefined(d))&&(d=n.id),i.messages.push(n),e++,s||i.$emit("messageReceived",n))}),e>0&&u&&t.hidden&&u.play(),o&&o(n)}i.loading=!1}).error(function(){i.loading=!1,o&&o(!1)})};i.loadingOlder=!1,i.disableOlder=!1,i.onScroll=function(n){i.disableOlder||0!=n||(console.log("Load old messages"),i.loadingOlder=!0,c({since:d,dir:"DESC"},function(n){0==n.data.length&&(i.disableOlder=!0),i.loadingOlder=!1}))};var l=function g(){i.settings.updateInterval&&e(function(){c({},g)},i.settings.updateInterval)};c({},l,!0),i.$on("$destroy",function(){i.settings.updateInterval=!1})}}}]).directive("angularTalkScroll",function(){return{priority:1,scope:{onScroll:"&"},restrict:"A",link:function(n,e){function t(){o.scrollTop=o.scrollHeight}function i(){return o.scrollTop+o.clientHeight+1>=o.scrollHeight}var o=e[0],s=!0;n.show=function(e){var t=document.getElementById(n.getMessageID(e));t&&(o.scrollTop=t.offsetTop)},n.$watch(function(){s&&t()}),e.bind("scroll",function(){s=i(),n.onScroll({offset:o.scrollTop})})}}}).service("windowStatus",function(){function n(n){var i={focus:!0,focusin:!0,pageshow:!0,blur:!1,focusout:!1,pagehide:!1};n=n||window.event,e.visible=n.type in i?i[n.type]:this[t]?!1:!0,e.hidden=!e.visible}var e={visible:!0,hidden:!1},t="hidden";return t in document?document.addEventListener("visibilitychange",n):(t="mozHidden")in document?document.addEventListener("mozvisibilitychange",n):(t="webkitHidden")in document?document.addEventListener("webkitvisibilitychange",n):(t="msHidden")in document?document.addEventListener("msvisibilitychange",n):"onfocusin"in document?document.onfocusin=document.onfocusout=n:window.onpageshow=window.onpagehide=window.onfocus=window.onblur=n,void 0!==document[t]&&n({type:document[t]?"blur":"focus"}),e}).run(["windowStatus",function(){}]);