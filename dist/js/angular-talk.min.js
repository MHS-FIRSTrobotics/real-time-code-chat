"use strict";angular.module("angularTalk",[]).directive("angularTalk",["$http","$timeout","windowStatus",function(n,e,i){return{restrict:"AC",scope:!0,templateUrl:"angularTalk/room.html",link:function(t,o,s){function r(n,e){var i=!1;return angular.forEach(e||t.messages,function(e){e.id&&e.id==n&&(i=e),!i&&e.$replies&&(i=r(n,e.$replies))}),i}function a(n){if(n.id){if(r(n.id))return;n.id>l&&(l=n.id),(n.id<c||angular.isUndefined(c))&&(c=n.id)}if(n.$replies=[],n.replyToID){var e=r(n.replyToID);e&&e.$replies.push(n)}else t.messages.push(n);t.$emit("messageReceived",n)}function d(e,o){t.loading=!0,n.get(u.ajaxEndpoint,{params:angular.extend({method:"messages",since:l,dir:"ASC",count:25},e)}).success(function(n){n.data&&(angular.forEach(n.data,a),n.data.length>0&&f&&i.hidden&&f.play(),o&&o(n)),t.loading=!1}).error(function(){t.loading=!1,o&&o(!1)})}var u=t.settings={};if(angular.forEach(s,function(n,e){t.settings[e]=""==n?!0:["strings","sender","soundOnNew"].indexOf(e)>=0?t.$eval(n):n}),!u.ajaxEndpoint)throw new Error("Invalid ajax endpoint");t.messages=[],t.message={},t.save=function(e){e.isSending=!0,e.isError=!1,e.isEditing=!1;var i={};angular.forEach(e,function(n,e){"$"!=e[0]&&0!==e.indexOf("is")&&(i[e]=n)}),n.post(u.ajaxEndpoint,i,{params:{method:e.id?"update":"submit"}}).success(function(n){e.isSending=!1,n.data&&(e.isError=!1,angular.extend(e,n.data),t.$emit("messageSend",e))}).error(function(){e.isSending=!1,e.isError=!0}),t.content=""},t.submit=function(n){n=angular.extend(n,{author:u.sender,date:new Date/1e3|0}),t.messages.push(n),t.save(n),t.message={}},t.messageKeyPress=function(n){return u.submitOnEnter&&13==n.keyCode?(t.submit(),n.preventDefault(),!1):void 0},t.reply=function(n){n.$replies.push({author:u.sender,isEditing:!0,content:"",date:new Date/1e3|0,replyToID:n.id})},t.edit=function(n){n.isEditing=!0},t.delete=function(e){confirm(u.strings.delete_confirm)&&n.post(u.ajaxEndpoint,e,{params:{method:"delete"}}).success(function(){function n(e,i){var t=i.indexOf(e);t>=0&&i.splice(t,1),angular.forEach(i,function(i){i.$replies&&n(e,i.$replies)})}n(e,t.messages)})},t.previousMessage=function(n){var e=void 0;return angular.forEach(t.messages,function(i){i.replyToID==n.replyToID&&i.id!=n.id&&i.date<=n.date&&(!e||e.date<i.date)&&(e=i)}),e};var c,l=0,f=null;u.soundOnNew&&(angular.isString(u.soundOnNew)?f=new Audio(u.soundOnNew):(f=document.createElement("audio"),angular.forEach(u.soundOnNew,function(n,e){var i=document.createElement("source");i.type=e,i.src=n,f.appendChild(i)}))),t.loadingOlder=!1,t.disableOlder=!1,t.onScroll=function(n){t.disableOlder||0!=n||(console.log("Load old messages"),t.loadingOlder=!0,d({since:c,dir:"DESC"},function(n){0==n.data.length&&(t.disableOlder=!0),t.loadingOlder=!1}))};var g=function p(){t.settings.updateInterval&&e(function(){d({},p)},t.settings.updateInterval)};d({},g,!0),t.$on("$destroy",function(){t.settings.updateInterval=!1})}}}]).directive("angularTalkScroll",function(){return{priority:1,scope:{onScroll:"&"},restrict:"A",link:function(n,e){function i(){o.scrollTop=o.scrollHeight}function t(){return o.scrollTop+o.clientHeight+1>=o.scrollHeight}var o=e[0],s=!0;n.$watch(function(){s&&i()}),e.bind("scroll",function(){s=t(),n.onScroll({offset:o.scrollTop})})}}}).directive("init",function(){return{priority:0,compile:function(){return{pre:function(n,e,i){n.$eval(i.init)}}}}}).service("windowStatus",function(){function n(n){var t={focus:!0,focusin:!0,pageshow:!0,blur:!1,focusout:!1,pagehide:!1};n=n||window.event,e.visible=n.type in t?t[n.type]:this[i]?!1:!0,e.hidden=!e.visible}var e={visible:!0,hidden:!1},i="hidden";return i in document?document.addEventListener("visibilitychange",n):(i="mozHidden")in document?document.addEventListener("mozvisibilitychange",n):(i="webkitHidden")in document?document.addEventListener("webkitvisibilitychange",n):(i="msHidden")in document?document.addEventListener("msvisibilitychange",n):"onfocusin"in document?document.onfocusin=document.onfocusout=n:window.onpageshow=window.onpagehide=window.onfocus=window.onblur=n,void 0!==document[i]&&n({type:document[i]?"blur":"focus"}),e}).run(["windowStatus",function(){}]);